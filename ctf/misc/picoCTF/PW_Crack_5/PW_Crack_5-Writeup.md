# PW_Crack_5 Writeup

## タグ

#CTF #PW_Crack #Crypto #Writeup

---

## 問題概要

**問題名**: PW Crack 5

配布物として以下が与えられている:

* `password checker`（実行可能バイナリまたはスクリプト）
* `level5.flag.txt.enc` （暗号化されたフラグ）
* `level5.hash.bin` （正解パスワードのMD5ハッシュ）
* `dictionary.txt` （試すべき全候補パスワード）

目的は辞書にある候補を用いて正しいパスワードを見つけ、暗号化フラグを復号してフラグ文字列を得ることである。

---

## 解析の要点（静的／動的）

1. ソース（または配布されているスクリプト）を確認すると、パスワード検証は**パスワードのMD5ダイジェスト**を比較していることが分かる。

   * `hash_pw` 関数は入力文字列をバイト化して `hashlib.md5()` に渡し、`digest()` を比較している。
2. フラグの復号は `str_xor(secret, key)` を用いた単純なXOR系の処理で行われている。

   * 与えられた `key` を `secret` の長さまで拡張し、対応バイト同士を XOR している。
   * ここで元実装は文字列（`str`）レベルで `ord` / `chr` を用いているため、バイナリに対しては文字コード依存の問題が起き得る。
3. 検証手順は次の通りである。

   * ユーザ入力からMD5を計算。
   * 比較が一致すれば `str_xor(flag_enc.decode(), user_pw)` で復号して出力。

---

## 攻略方針

1. ハッシュ照合がMD5であることがわかっているため、辞書攻撃で各候補のMD5を計算して `level5.hash.bin` と比較する。
2. 一致したパスワードで `level5.flag.txt.enc` をXOR復号する。
3. 実装上は**バイト列（bytes）での処理**にしておくと文字コードによる失敗を避けられる。

---

## 実装上の注意点 / トラブルシュート

* **文字コード**: 元の `str_xor` 実装は `str`（テキスト）レベルで `ord` / `chr` を使っているため、暗号化ファイルが非UTF-8バイト列を含むと `decode()` で失敗する可能性がある。上記スクリプトはバイト列で処理するため安全である。
* **keyの拡張方法**: 元の `str_xor` は `key` を `secret` 長まで拡張する際にキーの文字を順に追加している（`key[i]` を使って循環させる）。本質的にはキーを繰り返すのと等価であり、上記 `bytes_xor` はモジュロ演算で同等の処理を行う。
* **ハッシュアルゴリズム**: 本問題はMD5を用いている。MD5は衝突攻撃に弱いが、辞書照合の用途では問題ない。ハッシュがより遅い（bcrypt等）なら別戦略が必要である。
* **安全性**: バイナリ解析や未確認実行ファイルの実行は隔離環境（VM / container）で行うこと。

---

## 計算量（時間・空間）

* 辞書攻撃の時間計算量は候補数を `N` とした場合 `O(N * L)`。ここで `L` はパスワード長（ハッシュ計算・XORにかかる線形コスト）。
* 空間計算量は定数オーダー（ファイルの読み込みに `O(F)` が必要だが、辞書をストリームで処理しているので追加メモリはほぼ不要）。

---

## 実装上の注意点（細かい点）

* 辞書に非常に大量の候補がある場合は `hashcat` や `john` のような専用ツールの活用を検討することで高速化が可能である。
* 並列化：複数プロセスで辞書を分割して試すと短時間で当たる場合がある。
* もし `level5.hash.bin` がMD5ではなく別フォーマット（ヘッダを持つ等）であれば、バイナリ内容を十六進で確認して異常がないか確かめる。

---

## まとめ（問題ごとの要約表）

| 要素     | 内容                                |
| ------ | --------------------------------- |
| アルゴリズム | MD5 ハッシュ照合 + 繰り返しXORによる単純復号       |
| 攻略法    | 辞書攻撃でMD5一致を検出 → XOR復号             |
| 計算量    | 時間: O(N * L) 、 空間: O(1)（ストリーム処理時） |
| 実装上の注意 | バイト列処理、文字コード、隔離環境、専用ツールの活用        |

---
