#CTF #picoCTF #ReverseEngineering #Flag_Hunters

# Flag Hunters Writeup

## 1. 問題概要

本問題は picoCTF の Reverse Engineering 分野に属し、歌詞表示プログラムの挙動を解析することで、デフォルトでは表示されない隠しイントロ部（フラグ入り）を強制的に出力させる課題である。プログラムは Python で書かれており、歌詞の行を制御構文として解釈する特殊な仕様を持つ。

接続先:

```
nc verbal-sleep.picoctf.net 51777
```

## 2. 制約分析

提供された Python スクリプトは以下の特徴を持つ:

* 歌詞全体を `song_lines` として読み込み、1行ずつ処理する。
* セミコロン (`;`) によって複数命令を1行の中に書ける。
* 特殊命令:

  * `REFRAIN` → サビにジャンプ
  * `CROWD` → ユーザー入力を取得し、その行に再書き込み
  * `RETURN n` → 行番号 `n` に絶対ジャンプ
  * `END` → 終了
* フラグは `secret_intro` として **最上行付近 (`song_lines[0]`) に存在**。
* 実行開始地点は `[VERSE1]` の直後であり、フラグ部分は通常到達しない。

従って、`RETURN` 命令を任意行に注入できれば、フラグ表示行へジャンプできる。

## 3. 解法設計

### 3.1 キーとなる脆弱性

`CROWD` 入力処理は次の動作を行う:

```python
crowd = input('Crowd: ')
song_lines[lip] = 'Crowd: ' + crowd
```

保存された行は後に:

```python
for line in song_lines[lip].split(';'):
```

と処理されるため、**ユーザー入力に `;` を含めることで命令インジェクションが成立**する。

### 3.2 任意ジャンプの注入

フラグは最上部にあるため、ジャンプすべき場所は `song_lines[0]` である。従って CROWD 入力に次を与える:

```
;RETURN 0
```

これは、保存後に `Crowd: ;RETURN 0` となり、`;` により分割されて命令 `RETURN 0` が実行され、先頭行にジャンプする。

## 4. 実行手順

1. 接続する:

   ```bash
   nc verbal-sleep.picoctf.net 51777
   ```
2. 途中の歌詞が表示された後、次が表示される:

   ```
   Crowd:
   ```
3. 以下を入力する:

   ```
   ;RETURN 0
   ```
4. プログラム実行フローが最上部の `secret_intro` にジャンプし、フラグが出力される。

## 5. 計算量評価

本問題は制御フロー解析が主題であり計算量増大を伴う処理は存在しない。`O(N)` の行処理により完結する。

## 6. 実装上の注意点

* `RETURN n` が行番号の絶対指定であることを正しく理解すること。
* `CROWD` 入力はそのまま行へ書き込まれ後に split されるため、インジェクションの発火が2回目以降に発生する点に注意。
* セミコロン区切りの制御構造を悪用することが本問題の核心である。

## 7. 要約表

| 項目    | 内容                                   |
| ----- | ------------------------------------ |
| 分類    | Reverse Engineering / Code Injection |
| 主要手法  | セミコロン分割を利用した命令インジェクション               |
| 注入文字列 | `;RETURN 0`                          |
| フラグ位置 | `song_lines` の先頭 (secret_intro)      |
| 計算量   | O(N)                                 |
| 難易度   | 低〜中                                  |

---

本 Writeup は解析再現性を重視し、制御フローの理解を中心に構成した。
