# Base64

## 概要

**Base64** は、バイナリデータを 64 種類の印字可能文字（`A–Z a–z 0–9 + /`）で表す**可逆エンコード方式**。  
主目的は、**テキストしか扱えない環境（メール、プロトコル、設定ファイル等）でバイナリを安全に運ぶこと**。

- 3 バイト（24bit） → 6bit×4 に分割して 4 文字へ
- 端数は `=` または `==` で**パディング**する
- 出力サイズは**約 33% 増**（互換性を優先）

---

## 背景と文脈

初期のプロトコルやファイル形式は ASCII を前提としており、バイナリをそのまま載せると破損の恐れがあった。  
Base64 はこの制約を回避し、**電子メール（MIME）**, **HTTP ヘッダ**, **JSON/XML** など**テキスト基盤**でバイナリをやりとりする標準手段として普及。

---

## 仕組み（ビット観点）

### 3 バイト →4 文字（図解）

```

入力:  M      a      n
01001101 01100001 01101110  (ASCII)

6bit 分割:
010011  010110  000101  101110

インデックス→文字:
T       W       F       u

出力: "TWFu"

```

### サイズの数式

- 入力 n バイト → **エンコード後長 L（改行なし, パディング込み）**  
  **L = 4 × ceil(n / 3)**
- デコード後の元サイズ（`=` の個数を p ∈ {0,1,2} とする）  
  **n = (L / 4) × 3 − p**

### パディングと行折り返し

- パディング: 入力が 3 の倍数でないとき、末尾に `=`（2 文字不足）または `==`（1 文字不足）
- 行折り返し: MIME 系では **76 文字ごとに改行**を入れる慣習がある（実装や用途で異なる）

---

## バリアント（URL-safe Base64）

**Base64URL（RFC 4648）** は URL/クッキー向けの安全表記:

- 文字集合: `+`→`-`、`/`→`_`
- **パディング `=` を省略**する場合が多い（JWT など）
- 例：JWT のヘッダやペイロードは Base64URL（多くはパディング無し）

---

## 使用例（実務）

- **電子メール（MIME）**: 添付ファイルを Base64 化して本文に埋め込む
- **HTTP Basic 認証**: `username:password` を Base64 → `Authorization: Basic ...`
- **PEM 形式**: `-----BEGIN CERTIFICATE-----` の中身は Base64
- **データ URI**: `data:image/png;base64, iVBOR...` で画像等をインライン化
- **API/設定ファイル**: JSON/XML でバイナリをそのまま載せたいとき

> **注意**: Base64 は**暗号化ではない**（秘匿性なし）。Basic 認証は TLS と組み合わせて使うことが前提。

---

## 具体例

### 単一エンコード

入力：

```txt
hello
```

Base64：

```txt
aGVsbG8=
```

デコードすると `hello` に戻る。

### 多重エンコード（CTF で頻出）

入力：

```txt
flag{test}
```

1 回目：

```txt
ZmxhZ3t0ZXN0fQ==
```

2 回目：

```txt
Wm14aFozdDBaWE4wZlE9PQ==
```

3 回目：

```txt
V20xNGFGb3pkREJhV0U0d1psRTlQUT09
```

この最終文字列を**繰り返しデコード**すると `flag{test}` に戻る。

---

## よくある落とし穴

- **暗号と誤解**: Base64 は可読性を下げるだけで、**秘匿性ゼロ**。機微情報には**必ず暗号化 + TLS**。
- **文字コード問題**: デコード結果は**バイナリ**かもしれない。安易に UTF-8 と決め打ちしない。
- **改行/空白**: 実装によっては改行や空白が混ざる。**空白除去**か**ラッパ**で吸収する。
- **パディング省略**: JWT などでは `=` が無い。**長さを 4 の倍数に補正**してから解釈。
- **偽陽性**: 英数字記号で構成された文字列が Base64「っぽく」見えることがある。
  → **長さ・文字集合・デコード結果の再検査**を組み合わせて判断。

---

## 付録：テストベクタ

- `"Man"` → `TWFu`
- `"hello"` → `aGVsbG8=`
- `"flag{test}"`

  - 1 回目: `ZmxhZ3t0ZXN0fQ==`
  - 2 回目: `Wm14aFozdDBaWE4wZlE9PQ==`
  - 3 回目: `V20xNGFGb3pkREJhV0U0d1psRTlQUT09`

---

## まとめ

- Base64 は「**互換性と可搬性のための文字列表現**」。サイズ増は 33% 程度。
- メール、HTTP、PEM、データ URI、API など**実務の広範**で利用。
- CTF では**多重エンコード**が定番。パディング・文字集合・長さで見抜き、**スクリプトで反復デコード**。
