#分散システム理論  #データベース理論
## 概要
**CAP定理**とは、分散システムにおいて同時に満たすことができる特性の制限を示した理論であり、  
Consistency（一貫性）、Availability（可用性）、Partition Tolerance（分断耐性）の3つの特性のうち、**同時に満たせるのは2つまで**であることを示す。

この理論は2000年にEric Brewerによって提唱され、後にSeth GilbertとNancy Lynchによって形式的に証明された。

---

## 3つの特性

| 特性・名称                            | 意味                                                                              |
| -------------------------------- | ------------------------------------------------------------------------------- |
| **C: Consistency（一貫性）**          | すべてのノードが常に同じデータを返すこと。<br>任意の読み取り操作は、最新の書き込み結果を反映している必要がある。                      |
| **A: Availability（可用性）**         | どのノードにリクエストを送っても、必ず応答が返ってくること。<br>障害が発生してもサービスを継続できる。                           |
| **P: Partition Tolerance（分断耐性）** | ネットワークが分断（partition）されても、システムが動作を続けられること。<br>分散環境ではネットワーク障害を完全に防げないため、Pは現実的に必須。 |

---

## 理論の要点
分散システムがネットワーク分断（P）を受け入れる場合、**C（整合性）とA（可用性）を同時には保証できない**。  
つまり、設計上の選択は次の3通りになる：

1. **CPシステム**：整合性重視（可用性を犠牲にする）  
   - 例：HBase、Zookeeper、Etcd  
   - 分断時は書き込み・読み込みを停止し、一貫性を保つ。  

2. **APシステム**：可用性重視（整合性を犠牲にする）  
   - 例：Cassandra、DynamoDB、Riak  
   - 分断時も動作を続け、整合性は後で整える（最終的整合性）。  

3. **CAシステム**：理論上のみ存在（分断がない単一ノードなど）  
   - 例：単一ノードのRDBMS（MySQL単体など）。  
   - ネットワーク分断が前提にない場合のみ成立。

---

## 現実的な補足
現実の分散システムではP（分断耐性）を捨てることは不可能に近いため、  
設計者は **CとAのどちらを優先するか** を選択することになる。

また、CAP定理の単純な三択構造を補う理論として、**PACELC定理** がある。  
PACELCでは、分断時（P）だけでなく、分断がないとき（ELSE）の**レイテンシと整合性のトレードオフ**も考慮する。

---

## 代表的なシステム分類例

| システム | 分類 | 説明 |
|-----------|------|------|
| **Etcd / Zookeeper / HBase** | CP | 一貫性を優先、分断時は一部操作を停止。 |
| **Cassandra / DynamoDB / Riak** | AP | 可用性を優先、最終的整合性でデータを収束。 |
| **RDBMS（単一ノード）** | CA | 分散しない前提のためネットワーク分断が存在しない。 |

---

## まとめ
- CAP定理は、分散システム設計の根本的な制約を示す理論である。  
- 同時に満たせるのは **Consistency・Availability・Partition Tolerance のうち2つまで**。  
- 実システムでは、**Pを前提にCまたはAを選択する設計判断**が不可欠である。

---

## 参考文献
- Eric Brewer, “Towards Robust Distributed Systems,” PODC 2000.  
- Seth Gilbert, Nancy Lynch, “Brewer’s Conjecture and the Feasibility of Consistent, Available, Partition-Tolerant Web Services,” SIGACT News, 2002.  
- Werner Vogels, “Eventually Consistent,” CACM, 2009.
